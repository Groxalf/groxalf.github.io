<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Anoche haciendo los koans de Carlos Blé mi compañero Ronny y yo nos encontramos con dos grandes WATs de Javascript referentes a como funcionan los blo">
    

    <!--Author-->
    
        <meta name="author" content="Miguel Ángel Viera">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Javascript WATs. Scopes, closure y más."/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Miguel Viera"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Javascript WATs. Scopes, closure y más. - Miguel Viera</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Miguel Viera</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/Groxalf">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/images/header.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Javascript WATs. Scopes, closure y más.</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        2015-08-25
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/Uncategorized/">Uncategorized</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <script src="/assets/js/DPlayer.min.js"> </script><p>Anoche haciendo los koans de <a href="https://twitter.com/carlosble" target="_blank" rel="external">Carlos Blé</a> mi compañero <a href="https://twitter.com/RonnyAncorini" target="_blank" rel="external">Ronny</a> y yo nos encontramos con dos grandes WATs de Javascript referentes a como funcionan los bloques en este lenguaje.</p>
<p><strong>El primer WAT</strong> va sobre como funciona un Closure cuando el valor de la variable que toma se modifica fuera de su entorno. Para este ejemplo pondré el koan que resolvimos:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">it(<span class="string">"hoists variables the way you probably dont expect"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">var</span> functions = [];</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &amp;lt; <span class="number">5</span>; i++)&#123;</div><div class="line">        functions.push(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">          <span class="keyword">return</span> i;</div><div class="line">        &#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> functions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    expect(generate()[<span class="number">0</span>]()).toEqual(<span class="number">5</span>);</div><div class="line">    expect(generate()[<span class="number">1</span>]()).toEqual(<span class="number">5</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Como se puede ver, el closure está creando una función que retorna el valor de lo que valga la variable ‘i’ del for en ese momento. Los expects dejan claro que eso no es lo que ocurre. Lo que pasa en realidad es que el closure está cogiendo el valor de la ‘i’ por referencia del entorno al que pertenece, en este caso al de la función “generate”. Una solución en muchos otros lenguajes sería declararte una variable dentro del for y que sea esa la que coja el closure. Quedando algo así.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &amp;lt; <span class="number">5</span>; i++)&#123;</div><div class="line">    <span class="keyword">var</span> x = i;</div><div class="line">    functions.push(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">return</span> x;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Por desgracia, esto en Javascript no funcionará por una simple razón, los for no tienen su propio ámbito, por lo que todas las variables que crees dentro del for pertenecen realmente al scope de la función en la que se encuentra. Entonces para solucionarlo usamos los pasos por parámetro, ya que los tipos primitivos en Javascript (y en otros muchos lenguajes) al pasarse por parámetro copian su valor no su referencia.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &amp;lt; <span class="number">5</span>; i++)&#123;</div><div class="line">    functions.push(<span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</div><div class="line">      <span class="keyword">return</span> x;</div><div class="line">  &#125;(i));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Aunque esto tampoco sería la solución, porque al pasarle por parámetro el valor de la ‘i’ de esta forma, lo que se estaría guardando en el array sería el valor de la función una vez se resuelva y lo que realmente queremos conseguir es que se guarde la función con el valor que nosotros queramos. Por ello esta es la solución que se me ocurrió para resolver este problema. No se si hay alguna más sencilla y si alguien la conoce me haría un gran favor poniéndomela en los comentarios.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &amp;lt; <span class="number">5</span>; i++)&#123;</div><div class="line">    (<span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</div><div class="line">      functions.push(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">return</span> x;</div><div class="line">    &#125;))(i);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> functions;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>A partir de una función autoejecutable a la que le pasamos por parámetro el valor de la ‘i’ hacemos que el closure coja el valor de la variable que se le pasa por parámetro que es una copia del valor de la ‘i’ que está en un scope distinto al de la función “generate”. Con esto resolvemos el problema de hacer referencia a una variable que se modifica que pertenece a un scope distinto al de la función donde la queremos usar.</p>
<p><strong>El segundo WAT </strong>es sobre como Javascript asigna el scope a una función que pertenece a una clase en una variable en un scope distinto. Aquí está el koan al respecto con el ejemplo:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cat</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">this</span>.kilos = <span class="number">1</span>;</div><div class="line">        <span class="keyword">this</span>.feed = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">          <span class="keyword">this</span>.kilos++;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">this</span>.isPurring = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">it(<span class="string">"works different on dettached functions"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">var</span> cat = <span class="keyword">new</span> Cat();</div><div class="line">      <span class="built_in">window</span>.kilos = <span class="number">10</span>;</div><div class="line">      <span class="keyword">var</span> feed = cat.feed;</div><div class="line"></div><div class="line">      feed();</div><div class="line">      expect(<span class="built_in">window</span>.kilos).toEqual(<span class="number">11</span>);</div><div class="line">      expect(cat.kilos).toEqual(<span class="number">1</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Aquí lo que está ocurriendo es que al guardar en la variable ‘feed’ la función “feed” que está en la clase “Cat” al ejecutar la función, en vez de aplicarla sobre el objeto “cat” lo aplica al scope global. Esto ocurre porque cuando no le especificas el entorno al que la función pertenece esta automáticamente hereda el scope global. Esto se puede arreglar de varias formas.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.kilos = <span class="number">10</span>;</div><div class="line"><span class="keyword">this</span>.feed = cat.feed;</div><div class="line"><span class="keyword">this</span>.feed();</div></pre></td></tr></table></figure>
<p>Le puedes especificar el entorno en la misma función con el ‘this’.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> otherCat = <span class="keyword">new</span> Cat();</div><div class="line">otherCat.kilos = <span class="number">2</span>;</div><div class="line">otherCat.feed = cat.feed;</div><div class="line">otherCat.feed();</div></pre></td></tr></table></figure>
<p>Puedes crear un objeto “cat” distinto y sustituir la función feed de ese objeto por el de otro distinto, pero al especificarle el contexto al que pertenece aplicará las operaciones sobre ese mismo objeto y no al global.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> feed = cat.feed;</div><div class="line">feed.apply(cat);</div><div class="line">expect(cat.kilos).toEqual(<span class="number">2</span>);</div></pre></td></tr></table></figure>
<p>Otra opción es usar apply para indicarle el scope sobre el que tiene que aplicar la función, lo que habría que hacer una y otra vez el apply.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> feed = cat.feed.bind(cat);</div><div class="line">feed();</div><div class="line">feed();</div><div class="line">expect(cat.kilos).toEqual(<span class="number">3</span>);</div></pre></td></tr></table></figure>
<p>Otra distinta sería ligar la función al objeto “cat” con un bind al pasarle por parámetro el contexto al que se liga, para que cada vez que se llame a feed este sepa que el scope al que le aplica la función es al que se le ha ligado.</p>
<p>Y eso es todo, la verdad que estos  últimos días que he estado aprendiendo Javascript, le estoy sacando mucho partido y me está gustando mucho el lenguaje. Cosas como estás que al principio son un poco WAT luego cuando las entiendes te acaban gustando de verdad. Un saludo!</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                        <li>
                            <a href="https://twitter.com/Groxalf_Esp" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li>
                            <a href="https://github.com/Groxalf" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>